name: "Gem Compare"
description: "Compare different gem versions"
branding:
  icon: "search"
  color: "red"
inputs:
  gemrc:
    description: "Name of RubyGems config file (for development)"
    default: "gemrc"
    required: false
  pr_title:
    description: "String with gem name and from/to versions"
    default: "Bump sequel from 5.57.0 to 5.58.0"
    required: false
  pr_number:
    description: "The number of the pull request to comment in"
    default: 1
    required: false
  github-token:
    description: "The repo scoped token generated by GitHub Actions"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1

    - name: Extract info from pull request
      shell: bash
      run: |
        echo "PR_NUMBER=${{ github.event.pull_request.number || inputs.pr_number }}" >> $GITHUB_ENV
        echo "PR_TITLE=${{ github.event.pull_request.title || inputs.pr_title }}" >> $GITHUB_ENV

    # So our scripts can be found
    # https://docs.github.com/en/actions/creating-actions/creating-a-composite-action#creating-an-action-metadata-file
    - run: echo "${{ github.action_path }}" >> $GITHUB_PATH
      shell: bash

    - name: Parse pull request title
      shell: bash
      run: |
        echo "COMPARE_GEM=$(echo $PR_TITLE | parse_title name)" >> $GITHUB_ENV
        echo "COMPARE_FROM_VERSION=$(echo $PR_TITLE | parse_title from)" >> $GITHUB_ENV
        echo "COMPARE_TO_VERSION=$(echo $PR_TITLE | parse_title to)" >> $GITHUB_ENV

    - name: Install vendored copy of gem-compare
      shell: bash
      run: install_gem-compare
      env:
        GEM_CONFIG_FILE: ${{ inputs.gemrc }}
        BUNDLE_GEMFILE: "${{ github.action_path }}/Gemfile"

    - name: Run gem compare
      shell: bash
      run: |
        gem compare --config-file ./${{ github.action_path }}/${{ inputs.gemrc }} $COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION > compare_output.txt

    - name: Run gem compare --diff
      shell: bash
      run: |
        gem compare --config-file ./${{ github.action_path }}/${{ inputs.gemrc }} --diff $COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION > compare_diff.txt

    - name: Run gh pr comment
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        echo "## <code>gem compare "\
             "$COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION</code>" > comment.txt
        echo ''                        >> comment.txt
        echo '<Details><Summary>Output</Summary>' >> comment.txt
        echo ''                        >> comment.txt
        echo '````ruby'                >> comment.txt
        cat compare_output.txt         >> comment.txt
        echo '````'                    >> comment.txt
        echo '</Details>'              >> comment.txt
        echo ''                        >> comment.txt
        echo "## <code>gem compare --diff"\
             "$COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION</code>" >> comment.txt
        echo ''                        >> comment.txt
        echo '<Details><Summary>Output</Summary>' >> comment.txt
        echo ''                        >> comment.txt
        echo '````ruby'                >> comment.txt
        cat compare_diff.txt           >> comment.txt
        echo '````'                    >> comment.txt
        echo '</Details>'              >> comment.txt

        gh pr comment $PR_NUMBER --body-file comment.txt
